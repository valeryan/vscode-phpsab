name: Deploy Extension

on:
  release:
    types: [published]

env:
  TAG_NAME: ${{ github.ref_name }}
  TARGET_BRANCH: ${{ github.event.release.target_commitish }}

permissions:
  contents: write
  actions: read

jobs:
  validate-and-build:
    name: Validate Release and Build Extension
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    outputs:
      version: ${{ steps.parse-version.outputs.version }}
      is-valid: ${{ steps.parse-version.outputs.is-valid }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse and Validate Version
        id: parse-version
        run: |
          TAG_NAME="${{ env.TAG_NAME }}"

          # Remove 'v' prefix if present and validate semver format
          if [[ $TAG_NAME =~ ^v?([0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.-]+)?(\+[a-zA-Z0-9\.-]+)?)$ ]]; then
            VERSION=${BASH_REMATCH[1]}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is-valid=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Valid version format: $VERSION"
          else
            echo "is-valid=false" >> $GITHUB_OUTPUT
            echo "‚ùå Invalid version format: $TAG_NAME"
            echo "Version must follow semver format (e.g., v1.0.0, 1.0.0, v1.0.0-beta.1)"
            exit 1
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Lint and Test
        run: |
          npm run lint
          xvfb-run npm test

      - name: Build Extension
        run: npm run vscode:prepublish

      - name: Verify Build Output
        run: |
          if [ ! -f "out/main.js" ]; then
            echo "‚ùå Build failed: out/main.js not found"
            exit 1
          fi
          echo "‚úÖ Build successful"

  update-version-and-changelog:
    name: Update Version and Changelog
    needs: validate-and-build
    runs-on: ubuntu-latest
    if: needs.validate-and-build.outputs.is-valid == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Update Package Version
        run: |
          VERSION="${{ needs.validate-and-build.outputs.version }}"
          CURRENT_VERSION=$(node -p "require('./package.json').version")

          if [ "$VERSION" = "$CURRENT_VERSION" ]; then
            echo "‚ÑπÔ∏è  Package.json already has version $VERSION, skipping update"
          else
            echo "üì¶ Updating package.json from $CURRENT_VERSION to $VERSION"
            npm version $VERSION --no-git-tag-version
            echo "‚úÖ Successfully updated package version to $VERSION"
          fi

      - name: Get Release Notes and Update Changelog
        uses: actions/github-script@v7
        with:
          script: |
            const updateChangelog = await import('${{ github.workspace }}/.github/scripts/update-changelog.mjs');
            return await updateChangelog.default({ github, context, core });
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ env.TAG_NAME }}
          VERSION: ${{ needs.validate-and-build.outputs.version }}

      - name: Check for Changes
        id: git-check
        run: |
          # Check for any modified or untracked files
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "üìù Changes detected:"
            git status --porcelain
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No changes to commit"
          fi

      - name: Commit and Push All Changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git add package.json package-lock.json CHANGELOG.md
          git commit -m "chore: release ${{ env.TAG_NAME }}

          - Update version to ${{ needs.validate-and-build.outputs.version }}
          - Update CHANGELOG.md with release notes"
          git push origin HEAD:${{ env.TARGET_BRANCH }}

      - name: Update Tag Reference
        if: steps.git-check.outputs.changes == 'true'
        run: |
          # Move the existing tag to point to the new commit (preserves GitHub release relationship)
          git tag ${{ env.TAG_NAME }} -f
          git push origin ${{ env.TAG_NAME }} -f
          echo "‚úÖ Updated tag ${{ env.TAG_NAME }} to point to release commit"

  deploy:
    name: Deploy to Marketplaces
    needs: [validate-and-build, update-version-and-changelog]
    runs-on: ubuntu-latest
    environment: production
    if: github.event.release.prerelease == false
    steps:
      - name: Checkout Updated Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Publish to Open VSX Registry
        uses: HaaLeo/publish-vscode-extension@v1
        with:
          pat: ${{ secrets.OPEN_VSX_TOKEN }}

      - name: Publish to Visual Studio Marketplace
        uses: HaaLeo/publish-vscode-extension@v1
        with:
          pat: ${{ secrets.VS_MARKETPLACE_TOKEN }}
          registryUrl: https://marketplace.visualstudio.com

      - name: Report Success
        run: |
          echo "‚úÖ Successfully published to both marketplaces"
